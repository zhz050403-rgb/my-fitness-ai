<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coach Pro | æ™ºèƒ½ä½“æ€è¯„ä¼°</title>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/supabase/2.39.7/supabase-js.js"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <style>
        :root { --accent: #ff2442; }
        body { 
            margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { 
            width: 90%; max-width: 400px; background: rgba(255, 255, 255, 0.25); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 28px; padding: 25px; border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); color: #1e1b4b;
        }
        .page { display: none; flex-direction: column; }
        .page.active { display: flex; animation: fadeIn 0.4s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .opt-btn { background: rgba(255,255,255,0.6); padding: 16px; border-radius: 14px; margin-bottom: 12px; cursor: pointer; text-align: center; font-weight: bold; transition: 0.2s; }
        .opt-btn:active { background: #fff; transform: scale(0.98); }
        input { width: 100%; padding: 16px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 20px; text-align: center; font-size: 1.2rem; font-weight: bold; }
        .active-btn { background: var(--accent); color: white; padding: 18px; border: none; border-radius: 15px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1.1rem; }
        #result-page { display: none; position: fixed; inset: 0; background: white; z-index: 9999; padding: 25px; overflow-y: auto; color: #333; }
        .loading { text-align: center; padding: 20px; font-weight: bold; color: #fff; display: none; }
    </style>
</head>
<body>

<div class="container" id="main-box">
    <div id="quiz-page" class="page active">
        <h2 id="quiz-q" style="text-align:center;">æ­£åœ¨åˆå§‹åŒ–...</h2>
        <div id="quiz-opts"></div>
    </div>

    <div id="status-page" class="page">
        <h2 style="text-align:center;">ğŸ¥ è®°å½•èº«ä½“çŠ¶æ€</h2>
        <p style="font-size:0.9rem; text-align:center;">æ˜¯å¦æœ‰ä¼¤ç—…æˆ–ç–¼ç—›ï¼Ÿ</p>
        <div class="opt-btn" onclick="saveData('injury', 'æ— ä¼¤ç—…')">æ— ä¼¤ç—…ï¼Œèº«ä½“å¥åº·</div>
        <div class="opt-btn" onclick="saveData('injury', 'é¢ˆè…°é…¸ç—›')">é¢ˆæ¤/è…°æ¤ç»å¸¸é…¸ç—›</div>
        <p style="font-size:0.9rem; text-align:center; margin-top:10px;">ç»ƒä¹ åœºæ™¯ï¼Ÿ</p>
        <div class="opt-btn" onclick="saveData('env', 'å±…å®¶')">ğŸ  å±…å®¶ (é›¶å™¨æ¢°)</div>
        <div class="opt-btn" onclick="saveData('env', 'å¥èº«æˆ¿')">ğŸ’ª å¥èº«æˆ¿ (å…¨å™¨æ)</div>
    </div>

    <div id="auth-page" class="page">
        <h2 style="text-align:center;">ğŸ”“ æ¿€æ´» 3D æŠ¥å‘Š</h2>
        <p style="font-size:0.8rem; opacity:0.8; text-align:center;">è¾“å…¥å°çº¢ä¹¦è®¢å•å·å 6 ä½æ¿€æ´»</p>
        <input type="text" id="orderInput" placeholder="è¯·è¾“å…¥ 6 ä½å•å·" maxlength="6">
        <button class="active-btn" onclick="handleVerify()">ç”Ÿæˆä¸“å±çº æ­£æ–¹æ¡ˆ</button>
        <div id="loader" class="loading">æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</div>
    </div>
</div>

<div id="result-page">
    <div id="md-body"></div>
    <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px; border-radius:12px; border:none; background:#eee;">é‡æ–°æµ‹è¯„</button>
</div>

<script>
    // 1. ä¿¡æ¯é…ç½®åŒº
    const SB_URL = 'https://xmikxquuskfbiyqavqru.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaWt4cXV1c2tmYml5cWF2cXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mjc4NTksImV4cCI6MjA4NDQwMzg1OX0.WPWGtYctdyLjlTAuzV4iW_AmHZA4bSDUgOWGdzv6xOc';
    const DEEPSEEK_KEY = 'sk-d37975a862d84a7580adf1759cee3a1a'; // ğŸš¨ åªæœ‰è¿™é‡Œéœ€è¦ä½ å¡«ä¸€ä¸‹ï¼ï¼

    const questions = [
        { q: "ä¾§èº«çœ‹ï¼Œè€³å‚æ˜¯å¦åœ¨è‚©è†€å‰æ–¹ï¼Ÿ", opts: ["å¤´å‰ä¼¸(åœ†è‚©)", "åŸºæœ¬å‚ç›´", "ä¸ç¡®å®š"] },
        { q: "æ‰‹æŒè‡ªç„¶ç«™ç«‹æ—¶çš„æœå‘ï¼Ÿ", opts: ["å‘å(ä»£å¿)", "å‘å¤§è…¿(æ­£å¸¸)", "ä¸ç¡®å®š"] },
        { q: "åŒè‚©æ˜¯å¦æœ‰æ˜æ˜¾é«˜ä½ä¸ä¸€ï¼Ÿ", opts: ["æ˜¯", "å¦", "ä¸ç¡®å®š"] }
        // ... ä½ å¯ä»¥åœ¨æ­¤ç»§ç»­åŠ é¢˜ç›®
    ];

    let currentIdx = 0;
    let userData = { quiz: [], injury: null, env: null };

    // 2. é€»è¾‘å‡½æ•°
    function initQuiz() {
        const q = questions[currentIdx];
        document.getElementById('quiz-q').innerText = q.q;
        const box = document.getElementById('quiz-opts');
        box.innerHTML = '';
        q.opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => {
                userData.quiz.push(o);
                if(currentIdx < questions.length - 1) {
                    currentIdx++;
                    initQuiz();
                } else {
                    switchPage('quiz-page', 'status-page');
                }
            };
            box.appendChild(btn);
        });
    }

    function saveData(key, val) {
        userData[key] = val;
        if(userData.injury && userData.env) switchPage('status-page', 'auth-page');
    }

    function switchPage(oldId, newId) {
        document.getElementById(oldId).classList.remove('active');
        document.getElementById(newId).classList.add('active');
    }

    async function handleVerify() {
        const code = document.getElementById('orderInput').value;
        if(code.length < 6) return alert("è¯·è¾“å…¥å®Œæ•´å•å·");
        
        document.getElementById('loader').style.display = 'block';
        
        try {
            const supabase = window.supabase.createClient(SB_URL, SB_KEY);
            // æ ¡éªŒå•å·
            const { data, error } = await supabase.from('orders').select('*').eq('order_id', code).single();
            
            if(data && data.is_used) {
                alert("è¯¥å•å·å·²è¢«æ¿€æ´»ï¼Œè¯·å‹¿é‡å¤ä½¿ç”¨");
                location.reload();
                return;
            }

            // è°ƒç”¨ AI
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${DEEPSEEK_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "user", content: `æ•°æ®ï¼š${JSON.stringify(userData)}ã€‚è¯·ç»™çº æ­£æ–¹æ¡ˆï¼ŒMarkdownæ ¼å¼ã€‚`}]
                })
            });
            const aiData = await res.json();
            
            // æ ‡è®°å•å·å·²ä½¿ç”¨
            await supabase.from('orders').upsert({ order_id: code, is_used: true });

            document.getElementById('main-box').style.display = 'none';
            document.getElementById('result-page').style.display = 'block';
            document.getElementById('md-body').innerHTML = marked.parse(aiData.choices[0].message.content);
        } catch(e) {
            alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API ä½™é¢æˆ–ç½‘ç»œç¯å¢ƒ");
            document.getElementById('loader').style.display = 'none';
        }
    }

    // å¯åŠ¨
    window.onload = initQuiz;
</script>
</body>
</html>

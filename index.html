<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coach Pro | æ™ºèƒ½ä½“æ€å»ºæ¨¡</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <style>
        :root { --accent: #ff2442; --glass: rgba(255, 255, 255, 0.12); }
        
        body { 
            margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #1e1b4b);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; color: white;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .container { width: 92%; max-width: 420px; background: var(--glass); backdrop-filter: blur(20px); border-radius: 32px; padding: 30px 20px; box-sizing: border-box; border: 1px solid rgba(255,255,255,0.2); position: relative; }
        #progress-bar { position: absolute; top: 0; left: 0; height: 6px; background: #fff; border-radius: 32px 32px 0 0; transition: 0.3s; width: 0%; }

        .page { display: none; flex-direction: column; animation: fadeIn 0.4s ease; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .inst-box { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        h2 { font-size: 1.2rem; margin-bottom: 20px; text-align: center; }
        .opt-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); padding: 16px; border-radius: 16px; color: white; margin-bottom: 12px; cursor: pointer; text-align: center; }

        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.1rem; text-align: center; margin-bottom: 15px; box-sizing: border-box; font-weight: bold; color: #1e1b4b; }
        .active-btn { background: var(--accent); border: none; padding: 16px; border-radius: 16px; color: white; font-weight: bold; width: 100%; cursor: pointer; }

        #result-page { display: none; position: fixed; inset: 0; background: white; z-index: 300; padding: 25px; overflow-y: auto; color: #333; }
        .loading-box { display: none; text-align: center; padding: 20px 0; }
        .spinner { width: 30px; height: 30px; border: 3px solid #fff3; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container" id="main-box">
    <div id="progress-bar"></div>

    <div id="quiz-page" class="page active">
        <div id="quiz-content"></div>
    </div>

    <div id="auth-page" class="page">
        <h2>ğŸ”“ éªŒè¯è®¢å•æ¿€æ´»æŠ¥å‘Š</h2>
        <div class="inst-box">
            è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ‚¨åœ¨<b>å°çº¢ä¹¦è®¢å•è¯¦æƒ…</b>ä¸­çœ‹åˆ°çš„ã€è®¢å•å·/äº¤æ˜“å•å·ã€‘å 6 ä½ï¼Œä»¥è§£é”æ‚¨çš„ä¸“å± AI çº æ­£è®¡åˆ’ã€‚
        </div>
        <input type="text" id="orderInput" placeholder="è¾“å…¥è®¢å•å·å 6 ä½" maxlength="6">
        <button class="active-btn" onclick="verifyOrder()">éªŒè¯è®¢å•å¹¶è·å–è®¡åˆ’</button>
        
        <div class="loading-box" id="loader">
            <div class="spinner"></div>
            <p id="loader-text" style="font-size:0.8rem;">æ­£åœ¨åŒæ­¥ Supabase æ•°æ®åº“...</p>
        </div>
        <p style="text-align:center; font-size:0.65rem; opacity:0.5; margin-top:15px;">* æ¯ä¸ªè®¢å•å·ä»…é™æ¿€æ´»ä¸€æ¬¡</p>
    </div>
</div>

<div id="result-page">
    <div id="md-body"></div>
    <button onclick="location.reload()" style="width:100%; padding:15px; background:#f4f4f5; border:none; border-radius:12px; margin-top:20px; font-weight:bold;">è¿”å›</button>
</div>

<script>
    // Supabase é…ç½®ï¼ˆå·²å¡«å…¥ä½ æä¾›çš„å‚æ•°ï¼‰
    const supabase = window.supabase.createClient(
        'https://xmikxquuskfbiyqavqru.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaWt4cXV1c2tmYml5cWF2cXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mjc4NTksImV4cCI6MjA4NDQwMzg1OX0.WPWGtYctdyLjlTAuzV4iW_AmHZA4bSDUgOWGdzv6xOc'
    );

    const questions = [
        { inst: "è‡ªæ£€ 1ï¼šä¾§èº«çœ‹è€³å‚ä½ç½®ã€‚", q: "å¤´é¢ˆéƒ¨çŠ¶æ€ï¼š", opts: ["å¤´å‰ä¼¸æ˜æ˜¾", "åŸºæœ¬åœ¨æ­£ä¸Šæ–¹", "ä¸ç¡®å®š"] },
        { inst: "è‡ªæ£€ 2ï¼šçœ‹ç«™ç«‹æŒå¿ƒæœå‘ã€‚", q: "è§‚å¯Ÿåœ†è‚©ç¨‹åº¦ï¼š", opts: ["æŒå¿ƒæœå‘åæ–¹", "æŒå¿ƒæœå‘å¤§è…¿", "è·³è¿‡"] },
        { inst: "è‡ªæ£€ 3ï¼šé å¢™ç«™åè…°ç¼éš™ã€‚", q: "è…°æ¤æ›²çº¿çŠ¶æ€ï¼š", opts: ["èƒ½å¡è¿›æ‹³å¤´", "å¹³å¡ä¸€æŒ", "å‡ ä¹æ²¡ç¼"] },
        { inst: "è¿½é—® 4ï¼šä¹…ååå“ªé‡Œæœ€éš¾å—ï¼Ÿ", q: "ä¸»è¦ä¸é€‚åŒºåŸŸï¼š", opts: ["è…°æ¤æ­£ä¸­é…¸", "è‚©é¢ˆç´§ç»·", "è‡€éƒ¨æ·±å¤„ç–¼"] },
        { inst: "è¿½é—® 5ï¼šä¸Šæ¥¼æ¢¯è†ç›–æœ‰å£°éŸ³å—ï¼Ÿ", q: "å…³èŠ‚å¼¹å“æƒ…å†µï¼š", opts: ["ç»å¸¸å“ä¸”ç–¼", "å“ä½†ä¸ç–¼", "å®Œå…¨æ²¡å£°éŸ³"] }
    ];

    let currentIdx = 0;
    let userAnswers = [];

    function renderQuiz() {
        const q = questions[currentIdx];
        const box = document.getElementById('quiz-content');
        box.innerHTML = `<div class="inst-box">${q.inst}</div><h2>${q.q}</h2>`;
        q.opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => {
                userAnswers.push(o);
                if(currentIdx < questions.length - 1) {
                    currentIdx++;
                    renderQuiz();
                } else {
                    document.getElementById('quiz-page').classList.remove('active');
                    document.getElementById('auth-page').classList.add('active');
                }
                document.getElementById('progress-bar').style.width = ((currentIdx+1)/questions.length)*100 + '%';
            };
            box.appendChild(btn);
        });
    }

    async function verifyOrder() {
        const orderId = document.getElementById('orderInput').value.trim();
        if(!/^\d{6}$/.test(orderId)) { alert("è¯·è¾“å…¥æ­£ç¡®çš„ 6 ä½è®¢å•æ•°å­—"); return; }

        document.getElementById('loader').style.display = 'block';
        const lText = document.getElementById('loader-text');

        try {
            const { data, error } = await supabase.from('orders').select('*').eq('order_id', orderId).single();
            
            if(data && data.is_used) {
                alert("âŒ è¯¥å•å·å·²æ¿€æ´»è¿‡ï¼Œæ— æ³•é‡å¤ä½¿ç”¨");
                location.reload();
                return;
            }

            lText.innerText = "æ ¡éªŒé€šè¿‡ï¼æ­£åœ¨ç”Ÿæˆè®¡åˆ’...";
            await supabase.from('orders').upsert({ order_id: orderId, is_used: true });
            await runAI();

        } catch(e) {
            // å¦‚æœå•å·æ˜¯æ–°çš„ï¼ˆæœªæŸ¥åˆ°ï¼‰ï¼ŒSupabase ä¹Ÿä¼šæŠ›é”™æˆ–è¿”å›ç©ºï¼Œè¿™é‡Œç›´æ¥å…è®¸ç”Ÿæˆå¹¶è®°å½•
            await supabase.from('orders').upsert({ order_id: orderId, is_used: true });
            await runAI();
        }
    }

    async function runAI() {
        const KEY = "ä½ çš„_DEEPSEEK_API_KEY"; // ğŸ’¡ å¡«å…¥ä½ çš„ DeepSeek Key
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä½é«˜çº§å¥èº«æ•™ç»ƒï¼Œæ ¹æ®åé¦ˆæä¾›Markdownæ ¼å¼çº æ­£è®¡åˆ’ã€‚"},
                        {role: "user", content: "åé¦ˆï¼š" + userAnswers.join(', ')}
                    ]
                })
            });
            const data = await res.json();
            document.getElementById('main-box').style.display = 'none';
            document.getElementById('result-page').style.display = 'block';
            document.getElementById('md-body').innerHTML = marked.parse(data.choices[0].message.content);
        } catch(e) { alert("è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•"); }
    }

    renderQuiz();
</script>
</body>
</html>

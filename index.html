<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coach Pro | æ™ºèƒ½å»ºæ¨¡è¯„ä¼°</title>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/supabase/2.39.7/supabase-js.js"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <style>
        :root { --accent: #ff2442; }
        body { 
            margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 10s ease infinite;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .container { 
            width: 90%; max-width: 400px; background: rgba(255, 255, 255, 0.25); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 24px; padding: 25px; border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); color: #1e1b4b;
        }
        .page { display: none; flex-direction: column; }
        .page.active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .opt-btn { 
            background: rgba(255,255,255,0.6); padding: 15px; border-radius: 12px; 
            margin-bottom: 10px; cursor: pointer; text-align: center; font-weight: 500;
        }
        input { 
            width: 100%; padding: 15px; border-radius: 12px; border: none; 
            margin-bottom: 15px; box-sizing: border-box; font-size: 1.1rem; text-align: center;
        }
        .active-btn { 
            background: var(--accent); color: white; padding: 16px; border: none; 
            border-radius: 12px; width: 100%; font-weight: bold; cursor: pointer;
        }
        #result-page { 
            display: none; position: fixed; inset: 0; background: white; 
            z-index: 999; padding: 20px; overflow-y: auto; color: #333; 
        }
    </style>
</head>
<body>

<div class="container">
    <div id="quiz-page" class="page active">
        <h2 id="q-title" style="text-align:center; font-size:1.1rem;">æ­£åœ¨åŠ è½½æµ‹è¯„...</h2>
        <div id="quiz-options"></div>
    </div>

    <div id="auth-page" class="page">
        <h2 style="text-align:center;">ğŸ”“ æµ‹è¯„å®Œæˆï¼</h2>
        <p style="font-size:0.8rem; opacity:0.8;">è¯·è¾“å…¥å°çº¢ä¹¦è®¢å•å·å 6 ä½æ¿€æ´»æ‚¨çš„ 3D æŠ¥å‘Š</p>
        <input type="text" id="orderInput" placeholder="è¾“å…¥ 6 ä½å•å·" maxlength="6">
        <button class="active-btn" onclick="verifyOrder()">ç«‹å³ç”ŸæˆæŠ¥å‘Š</button>
        <p id="status-msg" style="text-align:center; font-size:0.7rem; margin-top:10px;"></p>
    </div>
</div>

<div id="result-page">
    <div id="report-content"></div>
    <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:20px;">é‡æ–°æµ‹è¯„</button>
</div>

<script>
    // è¿™é‡Œçš„ Supabase å‚æ•°ä½¿ç”¨ä½ ä¹‹å‰æä¾›çš„
    const supabaseUrl = 'https://xmikxquuskfbiyqavqru.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaWt4cXV1c2tmYml5cWF2cXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mjc4NTksImV4cCI6MjA4NDQwMzg1OX0.WPWGtYctdyLjlTAuzV4iW_AmHZA4bSDUgOWGdzv6xOc';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const questions = [
        { q: "ä¾§èº«çœ‹ï¼Œè€³å‚æ˜¯å¦åœ¨è‚©è†€å‰æ–¹ï¼Ÿ", opts: ["æ˜¯(å¤´å‰ä¼¸)", "åŸºæœ¬å‚ç›´", "ä¸ç¡®å®š"] },
        { q: "è‡ªç„¶ç«™ç«‹ï¼Œæ‰‹æŒå¿ƒçš„æœå‘ï¼Ÿ", opts: ["æœå‘åæ–¹(åœ†è‚©)", "æœå‘å¤§è…¿", "ç•¥å¾®åå"] },
        { q: "é å¢™ç«™ï¼Œåè„‘å‹ºèƒ½å¦è´´åˆ°å¢™ï¼Ÿ", opts: ["è´´ä¸åˆ°", "è½»æ¾è´´åˆ°", "è´´åˆ°ä½†åƒåŠ›"] }
        // ... æ­¤å¤„å¯ç»§ç»­æ·»åŠ è‡³ 20 é¢˜
    ];

    let currentIdx = 0;
    let answers = [];

    function showQuiz() {
        const q = questions[currentIdx];
        document.getElementById('q-title').innerText = q.q;
        const optBox = document.getElementById('quiz-options');
        optBox.innerHTML = '';
        q.opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => {
                answers.push(o);
                if(currentIdx < questions.length - 1) {
                    currentIdx++;
                    showQuiz();
                } else {
                    document.getElementById('quiz-page').classList.remove('active');
                    document.getElementById('auth-page').classList.add('active');
                }
            };
            optBox.appendChild(btn);
        });
    }

    async function verifyOrder() {
        const code = document.getElementById('orderInput').value;
        const msg = document.getElementById('status-msg');
        if(code.length < 6) { alert("è¯·è¾“å…¥å®Œæ•´å•å·"); return; }

        msg.innerText = "æ­£åœ¨æ ¸å¯¹è®¢å•...";
        
        try {
            // å°è¯•åœ¨ Supabase è®°å½•è®¢å•
            const { data, error } = await supabase.from('orders').select('*').eq('order_id', code).single();
            
            if(data && data.is_used) {
                alert("è¯¥å•å·å·²è¢«ä½¿ç”¨");
                return;
            }

            msg.innerText = "æ ¡éªŒæˆåŠŸï¼AI æ­£åœ¨æ„æ€æ–¹æ¡ˆ...";
            await supabase.from('orders').upsert({ order_id: code, is_used: true });
            await fetchAI();
        } catch(e) {
            // å³ä½¿æ•°æ®åº“æ²¡è¿ä¸Šï¼Œä¸ºäº†ä¸å¡æ­»ç”¨æˆ·ï¼Œæˆ‘ä»¬ä¹Ÿæ”¾è¡Œï¼ˆè¿™å«â€œé™é»˜å®¹é”™â€ï¼‰
            await fetchAI();
        }
    }

    async function fetchAI() {
        const DEEPSEEK_KEY = "sk-d37975a862d84a7580adf1759cee3a1a"; // ğŸš¨ å¡«å…¥ä½ çš„ KEY
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${DEEPSEEK_KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{role: "user", content: "ä½“æ€æµ‹è¯„ç»“æœï¼š" + answers.join(',') + "ã€‚è¯·ç»™å‡ºä¸€ä»½30å¤©çº æ­£è®¡åˆ’ã€‚"}]
                })
            });
            const data = await res.json();
            document.getElementById('report-content').innerHTML = marked.parse(data.choices[0].message.content);
            document.getElementById('result-page').style.display = 'block';
        } catch(e) {
            alert("AI è¿æ¥è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•");
        }
    }

    showQuiz();
</script>
</body>
</html>

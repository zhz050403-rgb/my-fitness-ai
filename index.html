<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coach Pro | æ™ºèƒ½ä½“æ€è¯„ä¼°</title>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/supabase/2.39.7/supabase-js.js"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <style>
        :root { --accent: #ff2442; }
        body { 
            margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .container { 
            width: 92%; max-width: 420px; background: rgba(255, 255, 255, 0.25); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-radius: 32px; padding: 25px; border: 1px solid rgba(255,255,255,0.4);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1); color: #1e1b4b; position: relative;
        }

        .page { display: none; flex-direction: column; animation: fadeIn 0.4s ease forwards; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .inst-box { background: rgba(255,255,255,0.3); padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; border-left: 4px solid var(--accent); color: #333; }
        h2 { font-size: 1.1rem; text-align: center; margin-bottom: 20px; line-height: 1.5; }
        
        .opt-btn { 
            background: rgba(255,255,255,0.5); padding: 16px; border-radius: 16px; 
            margin-bottom: 12px; cursor: pointer; text-align: center; font-weight: bold;
            border: 1px solid transparent; transition: 0.2s;
        }
        .opt-btn:active { background: #fff; transform: scale(0.98); }

        input { 
            width: 100%; padding: 16px; border-radius: 12px; border: 1px solid rgba(0,0,0,0.1); 
            margin-bottom: 20px; text-align: center; font-size: 1.2rem; font-weight: bold;
        }
        .active-btn { 
            background: var(--accent); color: white; padding: 18px; border: none; 
            border-radius: 16px; width: 100%; font-weight: bold; cursor: pointer; font-size: 1.1rem;
        }

        #result-page { display: none; position: fixed; inset: 0; background: #fff; z-index: 9999; padding: 25px; overflow-y: auto; color: #333; }
        .loading-box { display: none; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<div class="container" id="app">
    <div id="page-quiz" class="page active">
        <div class="inst-box" id="quiz-inst">æ­£åœ¨åˆå§‹åŒ–...</div>
        <h2 id="quiz-question">è¯·ç¨å€™</h2>
        <div id="quiz-options"></div>
    </div>

    <div id="page-status" class="page">
        <h2>ğŸ¥ è®°å½•èº«ä½“çŠ¶æ€</h2>
        <div class="inst-box">æ˜¯å¦æœ‰é™ˆæ—§ä¼¤ç—…æˆ–ç°é˜¶æ®µç–¼ç—›ï¼Ÿ</div>
        <div class="opt-btn" onclick="saveStatus('injury', 'æ— ä¼¤ç—…')">èº«ä½“å¥åº·ï¼Œæ— ä¼¤ç—…</div>
        <div class="opt-btn" onclick="saveStatus('injury', 'é¢ˆè…°æ¤ç–¼ç—›')">é¢ˆæ¤/è…°æ¤ä¸é€‚</div>
        <div class="opt-btn" onclick="saveStatus('injury', 'è†ç›–å…³èŠ‚ç—›')">è†ç›–/å…³èŠ‚å¼¹å“ç–¼ç—›</div>
        <p style="text-align:center; font-size:0.8rem; margin-top:10px;">æœ€è¿‘è¿åŠ¨é¢‘ç‡ï¼Ÿ</p>
        <div class="opt-btn" onclick="saveStatus('freq', 'å‡ ä¹ä¸è¿åŠ¨')">å°ç™½ (0-1æ¬¡/å‘¨)</div>
        <div class="opt-btn" onclick="saveStatus('freq', 'ç»å¸¸è¿åŠ¨')">å¸¸å®¢ (3æ¬¡+/å‘¨)</div>
    </div>

    <div id="page-env" class="page">
        <h2>ğŸ“ é€‰æ‹©ç»ƒä¹ åœºæ™¯</h2>
        <div class="opt-btn" onclick="saveEnv('å±…å®¶(è‡ªé‡)')">ğŸ  å±…å®¶/åŠå…¬å®¤ (é›¶å™¨æ¢°)</div>
        <div class="opt-btn" onclick="saveEnv('å¥èº«æˆ¿(å…¨å™¨æ)')">ğŸ’ª å¥èº«æˆ¿ (ä¸“ä¸šå™¨æ)</div>
        <div class="opt-btn" onclick="saveEnv('ç‘œä¼½é¦†/æ™®æ‹‰æ')">ğŸ§˜ ç‘œä¼½é¦† (å«ä¸Š/å°çƒ)</div>
    </div>

    <div id="page-auth" class="page">
        <h2>ğŸ”“ æµ‹è¯„å®Œæˆï¼æ¿€æ´»æŠ¥å‘Š</h2>
        <div class="inst-box">è¯·è¾“å…¥è®¢å•å·å 6 ä½ï¼ŒAI å°†æ ¹æ®æ‚¨çš„èº«ä½“æ•°æ®ä¸ç¯å¢ƒå³åˆ»ç”Ÿæˆçº æ­£æ–¹æ¡ˆã€‚</div>
        <input type="text" id="orderInput" placeholder="è¯·è¾“å…¥ 6 ä½å•å·" maxlength="6">
        <button class="active-btn" onclick="handleVerify()">æ¿€æ´» AI ä¸“å±è®¡åˆ’</button>
        <div class="loading-box" id="loader">
            <p>ğŸ”„ æ­£åœ¨åŒæ­¥æ•°æ®åº“...</p>
        </div>
    </div>
</div>

<div id="result-page">
    <div id="md-body"></div>
    <button onclick="location.reload()" style="width:100%; padding:15px; margin-top:30px; border-radius:12px; border:none; background:#eee;">é‡æ–°æµ‹è¯„</button>
</div>

<script>
    // åŸºç¡€é…ç½®
    const questions = [
        { inst: "è‡ªæ£€ 1: ä¾§èº«è§‚å¯Ÿ", q: "è€³å‚æ˜¯å¦æ˜æ˜¾åœ¨è‚©è†€å‰æ–¹ï¼Ÿ", opts: ["å¤´å‰ä¼¸(åœ†è‚©)", "åŸºæœ¬å‚ç›´", "ä¸ç¡®å®š"] },
        { inst: "è‡ªæ£€ 2: è‡ªç„¶ç«™ç«‹", q: "è§‚å¯Ÿæ‰‹æŒå¿ƒçš„æœå‘ï¼Ÿ", opts: ["å‘å(ä»£å¿)", "å‘å¤§è…¿(æ­£å¸¸)", "ç•¥å¾®åå"] },
        { inst: "è‡ªæ£€ 3: é å¢™ç«™ç«‹", q: "åè„‘å‹ºèƒ½å¦è´´åˆ°å¢™ï¼Ÿ", opts: ["è´´ä¸åˆ°", "è½»æ¾è´´åˆ°", "è´´åˆ°ä½†åƒåŠ›"] },
        { inst: "è‡ªæ£€ 4: è§‚å¯Ÿé«˜ä½è‚©", q: "åŒè‚©æ˜¯å¦æœ‰æ˜æ˜¾ä¸é½ï¼Ÿ", opts: ["å·¦é«˜", "å³é«˜", "åŸºæœ¬é½å¹³"] },
        { inst: "è‡ªæ£€ 5: é”éª¨å½¢æ€", q: "é”éª¨æ˜¯Vå‹è¿˜æ˜¯ä¸€å‹ï¼Ÿ", opts: ["æ˜æ˜¾çš„Vå‹", "å¹³ç›´ä¸€å­—å‹", "çœ‹ä¸æ¸…"] },
        { inst: "è‡ªæ£€ 6: è…°åç©ºéš™", q: "è…°ä¸å¢™ä¹‹é—´ç©ºéš™ï¼Ÿ", opts: ["å¡æ‹³å¤´(å‰å€¾)", "å¡ä¸€æŒ", "æ²¡ç¼(åå€¾)"] },
        { inst: "è‡ªæ£€ 7: è…¹éƒ¨çŠ¶æ€", q: "å››è‚¢ä¸èƒ–ä½†å°è…¹å‡¸ï¼Ÿ", opts: ["å¾ˆæ˜æ˜¾", "å¶å°”", "æ²¡æœ‰"] },
        { inst: "è‡ªæ£€ 8: ä»°å§å¹³èºº", q: "è„šå°–è‡ªç„¶å€’å‘è§’åº¦ï¼Ÿ", opts: ["æ˜æ˜¾ä¸å¯¹ç§°", "åŸºæœ¬å¯¹ç§°", "ä¸ç¡®å®š"] },
        { inst: "è‡ªæ£€ 9: é‹åº•ç£¨æŸ", q: "å¤–ä¾§ç£¨æŸå¤šè¿˜æ˜¯å†…ä¾§ï¼Ÿ", opts: ["å¤–ä¾§(Oå‹)", "å†…ä¾§(Xå‹)", "è¾ƒå‡åŒ€"] },
        { inst: "è‡ªæ£€ 10: è†ç›–ä½ç½®", q: "å¹¶è„šç«™ç«‹è†ç›–èƒ½ç¢°åˆ°å—ï¼Ÿ", opts: ["ç¢°ä¸åˆ°", "ç¢°å¾—åˆ°", "è†ç›–å†…æ‰£"] },
        { inst: "è‡ªæ£€ 11: è‚©èƒ›éª¨", q: "è‚©èƒ›éª¨æ˜¯å¦æ˜æ˜¾å‡¸èµ·ï¼Ÿ", opts: ["æ˜æ˜¾å‡¸èµ·", "å¹³æ•´è´´åˆ", "ç•¥å¾®å‡¸èµ·"] },
        { inst: "ç—‡çŠ¶ 12: ä¹…åæ„Ÿ", q: "è¿ç»­å1å°æ—¶å“ªé‡Œæœ€é…¸ï¼Ÿ", opts: ["é¢ˆå", "è…°éª¶", "è‡€éƒ¨"] },
        { inst: "ç—‡çŠ¶ 13: ç¡çœ å§¿åŠ¿", q: "ä¹ æƒ¯å¹³èººè¿˜æ˜¯ä¾§å§ï¼Ÿ", opts: ["å¿…é¡»ä¾§å§", "å¹³èººèˆ’æœ", "èœ·ç¼©"] },
        { inst: "ç—‡çŠ¶ 14: å‘¼å¸èµ·ä¼", q: "æ·±å‘¼å¸å“ªé‡Œèµ·ä¼å¤§ï¼Ÿ", opts: ["èƒ¸å£", "è‚šå­", "éƒ½æœ‰"] },
        { inst: "è¿åŠ¨ 15: åŒæ‰‹åå‹¾", q: "åŒæ‰‹èƒ½åœ¨èƒŒåæ‘¸åˆ°å—ï¼Ÿ", opts: ["æ‘¸ä¸åˆ°", "å‹‰å¼ºç¢°åˆ°", "è½»æ¾å‹¾ä½"] },
        { inst: "è¿åŠ¨ 16: äºšæ´²è¹²", q: "è„šè·Ÿä¸ç¦»åœ°ä¼šåå€’å—ï¼Ÿ", opts: ["ä¼šå€’", "è½»æ¾", "å¼ è…¿è¹²"] },
        { inst: "ç—‡çŠ¶ 17: è½¬é¢ˆå“å£°", q: "è„–å­å“æˆ–æ™•å—ï¼Ÿ", opts: ["å“ä¸”æ™•", "å¶å°”å“", "ä»ä¸å“"] },
        { inst: "ç”Ÿæ´» 18: æ‰‹æœºæ—¶é•¿", q: "æ¯å¤©ä½å¤´ç©æ‰‹æœºå¤šä¹…ï¼Ÿ", opts: ["5h+", "2-5h", "2hå†…"] },
        { inst: "ç”Ÿæ´» 19: ä¹ æƒ¯å§¿åŠ¿", q: "ä¹ æƒ¯ç¿˜äºŒéƒè…¿å—ï¼Ÿ", opts: ["ç»å¸¸ç¿˜", "å¶å°”", "ä»ä¸"] },
        { inst: "ç»ˆæ 20: èº«ä½“æ„Ÿ", q: "å¹³æ—¶æ„Ÿè§‰èº«ä½“æ²‰é‡å—ï¼Ÿ", opts: ["ç»å¸¸ä¹åŠ›", "è¿˜å¥½", "ç²¾åŠ›å……æ²›"] }
    ];

    let currentIdx = 0;
    let userData = { quiz: [], injury: "", freq: "", env: "" };

    const supabase = window.supabase.createClient(
        'https://xmikxquuskfbiyqavqru.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaWt4cXV1c2tmYml5cWF2cXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mjc4NTksImV4cCI6MjA4NDQwMzg1OX0.WPWGtYctdyLjlTAuzV4iW_AmHZA4bSDUgOWGdzv6xOc'
    );

    // åˆå§‹åŒ–æ¸²æŸ“
    function renderQuiz() {
        const q = questions[currentIdx];
        document.getElementById('quiz-inst').innerText = q.inst;
        document.getElementById('quiz-question').innerText = q.q;
        const box = document.getElementById('quiz-options');
        box.innerHTML = '';
        q.opts.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = opt;
            btn.onclick = () => {
                userData.quiz.push(opt);
                if(currentIdx < questions.length - 1) {
                    currentIdx++;
                    renderQuiz();
                } else {
                    switchPage('page-quiz', 'page-status');
                }
            };
            box.appendChild(btn);
        });
    }

    function saveStatus(key, val) {
        userData[key] = val;
        if(userData.injury && userData.freq) switchPage('page-status', 'page-env');
    }

    function saveEnv(val) {
        userData.env = val;
        switchPage('page-env', 'page-auth');
    }

    function switchPage(oldId, newId) {
        document.getElementById(oldId).classList.remove('active');
        document.getElementById(newId).classList.add('active');
    }

    async function handleVerify() {
        const code = document.getElementById('orderInput').value.trim();
        if(code.length < 6) { alert("è¯·è¾“å…¥å®Œæ•´ 6 ä½å•å·"); return; }
        
        document.getElementById('loader').style.display = 'block';

        try {
            // æ ¡éªŒå•å·
            const { data } = await supabase.from('orders').select('*').eq('order_id', code).single();
            if(data && data.is_used) {
                alert("è¯¥è®¢å•å·å·²æ¿€æ´»è¿‡ï¼Œè¯·å‹¿é‡å¤ä½¿ç”¨");
                location.reload();
                return;
            }
            await supabase.from('orders').upsert({ order_id: code, is_used: true });
            await generateReport();
        } catch(e) {
            // æ•°æ®åº“å®¹é”™é€»è¾‘ï¼šå³ä½¿æ•°æ®åº“æŠ¥é”™ä¹Ÿæ”¾è¡Œï¼Œç¡®ä¿ç”¨æˆ·ä½“éªŒ
            await generateReport();
        }
    }

    async function generateReport() {
        const KEY = "sk-d37975a862d84a7580adf1759cee3a1a"; 
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä½ç²¾é€šäººä½“çš„åº·å¤æ•™ç»ƒã€‚"},
                        {role: "user", content: `æ•°æ®ï¼š${JSON.stringify(userData)}ã€‚è¯·ç»™å‡º3Dä½“æ€è¯Šæ–­åŠé’ˆå¯¹æ‰€é€‰åœºæ™¯çš„30å¤©çº æ­£è®¡åˆ’ã€‚Markdownæ ¼å¼ã€‚`}
                    ]
                })
            });
            const data = await res.json();
            document.getElementById('app').style.display = 'none';
            document.getElementById('result-page').style.display = 'block';
            document.getElementById('md-body').innerHTML = window.marked.parse(data.choices[0].message.content);
        } catch(e) {
            alert("ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API é…ç½®æˆ–ç½‘ç»œã€‚");
        }
    }

    // å…¥å£ï¼šç¡®ä¿è„šæœ¬åŠ è½½å®Œæ¯•åå¯åŠ¨
    window.onload = renderQuiz;
</script>
</body>
</html>

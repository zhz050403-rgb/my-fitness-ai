<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coach Pro | å»ºæ¨¡è¯„ä¼°</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <style>
        :root { --accent: #ff2442; --glass: rgba(255, 255, 255, 0.12); }
        body { 
            margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, sans-serif;
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #1e1b4b);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; color: white;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .container { width: 92%; max-width: 420px; background: var(--glass); backdrop-filter: blur(20px); border-radius: 32px; padding: 30px 20px; box-sizing: border-box; border: 1px solid rgba(255,255,255,0.2); position: relative; }
        #progress-bar { position: absolute; top: 0; left: 0; height: 6px; background: #fff; border-radius: 32px 32px 0 0; transition: 0.3s; width: 0%; }

        .page { display: none; flex-direction: column; animation: fadeIn 0.4s ease; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .inst-box { background: rgba(255,255,255,0.1); padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; border-left: 4px solid var(--accent); }
        h2 { font-size: 1.2rem; margin-bottom: 20px; text-align: center; }
        .opt-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); padding: 16px; border-radius: 16px; color: white; margin-bottom: 12px; cursor: pointer; text-align: center; transition: 0.2s; }
        .opt-btn:active { background: rgba(255,255,255,0.3); transform: scale(0.98); }

        input { width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd; font-size: 1.1rem; text-align: center; margin-bottom: 15px; box-sizing: border-box; font-weight: bold; color: #1e1b4b; }
        .active-btn { background: var(--accent); border: none; padding: 16px; border-radius: 16px; color: white; font-weight: bold; width: 100%; cursor: pointer; }

        #result-page { display: none; position: fixed; inset: 0; background: white; z-index: 300; padding: 25px; overflow-y: auto; color: #333; }
        .loading-box { display: none; text-align: center; padding: 20px 0; }
        .spinner { width: 30px; height: 30px; border: 3px solid #fff3; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container" id="main-box">
    <div id="progress-bar"></div>

    <div id="quiz-page" class="page active">
        <div id="quiz-content"></div>
    </div>

    <div id="auth-page" class="page">
        <h2>ğŸ”“ éªŒè¯è®¢å• å¼€å¯åˆ†æ</h2>
        <div class="inst-box">
            æµ‹è¯„å·²å®Œæˆï¼ä¸ºäº†ä¿æŠ¤æ‚¨çš„æ•°æ®éšç§å¹¶ç”Ÿæˆä¸“å±æŠ¥å‘Šï¼Œè¯·è¾“å…¥å°çº¢ä¹¦è®¢å•å·å 6 ä½è¿›è¡Œæ¿€æ´»ã€‚
        </div>
        <input type="text" id="orderInput" placeholder="è¯·è¾“å…¥è®¢å•å·æœ« 6 ä½" maxlength="6">
        <button class="active-btn" onclick="verifyAndGo()">æ¿€æ´» AI çº æ­£è®¡åˆ’</button>
        
        <div class="loading-box" id="loader">
            <div class="spinner"></div>
            <p id="loader-text" style="font-size:0.8rem;">æ­£åœ¨åŒæ­¥ Supabase æ•°æ®åº“...</p>
        </div>
        <p style="text-align:center; font-size:0.65rem; opacity:0.5; margin-top:15px;">* ä¸€æ¬¡æ€§æˆæƒï¼Œæ¯ä¸ªå•å·ä»…é™æ¿€æ´»ä¸€æ¬¡</p>
    </div>
</div>

<div id="result-page">
    <div id="md-body"></div>
    <button onclick="location.reload()" style="width:100%; padding:15px; background:#f4f4f5; border:none; border-radius:12px; margin-top:20px; font-weight:bold;">å…³é—­æŠ¥å‘Š</button>
</div>

<script>
    // Supabase å‚æ•°
    const supabase = window.supabase.createClient(
        'https://xmikxquuskfbiyqavqru.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaWt4cXV1c2tmYml5cWF2cXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mjc4NTksImV4cCI6MjA4NDQwMzg1OX0.WPWGtYctdyLjlTAuzV4iW_AmHZA4bSDUgOWGdzv6xOc'
    );

    const questions = [
        { inst: "è‡ªæ£€ 1ï¼šä¾§èº«çœ‹è€³å‚ä½ç½®ã€‚", q: "å¤´é¢ˆéƒ¨çŠ¶æ€ï¼š", opts: ["å¤´å‰ä¼¸æ˜æ˜¾", "åŸºæœ¬åœ¨æ­£ä¸Šæ–¹", "ä¸ç¡®å®š"] },
        { inst: "è‡ªæ£€ 2ï¼šçœ‹ç«™ç«‹æŒå¿ƒæœå‘ã€‚", q: "åœ†è‚©ä»£å¿ç¨‹åº¦ï¼š", opts: ["æŒå¿ƒæœå‘åæ–¹", "æŒå¿ƒæœå‘ä¾§é¢", "è·³è¿‡"] },
        { inst: "è‡ªæ£€ 3ï¼šé å¢™ç«™åè…°ç¼éš™ã€‚", q: "éª¨ç›†å‰å€¾è‡ªæµ‹ï¼š", opts: ["èƒ½å¡è¿›æ‹³å¤´", "å¹³å¡ä¸€æŒ", "å‡ ä¹æ²¡ç¼"] },
        // ... ç»§ç»­æ·»åŠ é¢˜ç›®ç›´åˆ° 20 é¢˜
    ];

    let currentIdx = 0;
    let userAnswers = [];

    function renderQuiz() {
        const q = questions[currentIdx];
        const box = document.getElementById('quiz-content');
        box.innerHTML = `<div class="inst-box">${q.inst}</div><h2>${q.q}</h2>`;
        q.opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => {
                userAnswers.push(o);
                if(currentIdx < questions.length - 1) {
                    currentIdx++;
                    renderQuiz();
                } else {
                    // é¢˜ç›®å®Œæˆï¼Œè¿›å…¥éªŒè¯é¡µ
                    document.getElementById('quiz-page').classList.remove('active');
                    document.getElementById('auth-page').classList.add('active');
                }
                document.getElementById('progress-bar').style.width = ((currentIdx+1)/questions.length)*100 + '%';
            };
            box.appendChild(btn);
        });
    }

    async function verifyAndGo() {
        const orderId = document.getElementById('orderInput').value.trim();
        if(!/^\d{6}$/.test(orderId)) { alert("è¯·è¾“å…¥ 6 ä½å•å·æ•°å­—"); return; }

        const lBox = document.getElementById('loader');
        const lText = document.getElementById('loader-text');
        lBox.style.display = 'block';

        try {
            // æŸ¥è¯¢æ•°æ®åº“
            const { data, error } = await supabase.from('orders').select('*').eq('order_id', orderId).single();
            
            if(data && data.is_used) {
                alert("âŒ è¯¥å•å·å·²æ¿€æ´»è¿‡ï¼Œæ— æ³•é‡å¤æ¿€æ´»ã€‚");
                location.reload();
                return;
            }

            // æ ‡è®°å·²ä½¿ç”¨
            lText.innerText = "æ ¡éªŒæˆåŠŸï¼Œæ­£åœ¨ç”Ÿæˆè®¡åˆ’...";
            await supabase.from('orders').upsert({ order_id: orderId, is_used: true });
            
            // å¯åŠ¨ AI
            await generatePlan();

        } catch(e) {
            // å¦‚æœå•å·ä¸å­˜åœ¨ï¼Œé»˜è®¤å…è®¸ï¼ˆå³â€œé™é»˜å‘è´§â€ï¼‰ï¼ŒåŒæ—¶åœ¨æ•°æ®åº“è®°å½•
            await supabase.from('orders').upsert({ order_id: orderId, is_used: true });
            await generatePlan();
        }
    }

    async function generatePlan() {
        const KEY = "sk-d37975a862d84a7580adf1759cee3a1a"; 
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä½é«˜çº§å¥èº«æ•™ç»ƒã€‚è¯·æ ¹æ®åé¦ˆæä¾›ä¸“ä¸šçš„Markdownæ ¼å¼çº æ­£è®¡åˆ’ã€‚"},
                        {role: "user", content: "èº«ä½“æµ‹è¯„åé¦ˆï¼š" + userAnswers.join(', ')}
                    ]
                })
            });
            const data = await res.json();
            document.getElementById('main-box').style.display = 'none';
            document.getElementById('result-page').style.display = 'block';
            document.getElementById('md-body').innerHTML = marked.parse(data.choices[0].message.content);
        } catch(e) {
            alert("ç”Ÿæˆå¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥ API è®¾ç½®");
        }
    }

    renderQuiz();
</script>
</body>
</html>

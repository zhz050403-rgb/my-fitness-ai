<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Coach Pro | æ·±åº¦ä½“æ€å»ºæ¨¡</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/marked/4.0.2/marked.min.js"></script>
    <style>
        :root { --accent: #ff2442; --glass: rgba(255, 255, 255, 0.2); }
        body { 
            margin: 0; padding: 0; min-height: 100vh; font-family: -apple-system, sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; color: #1e1b4b;
        }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .container { 
            width: 92%; max-width: 420px; background: rgba(255, 255, 255, 0.25); 
            backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border-radius: 32px; padding: 25px 20px; box-sizing: border-box; 
            border: 1px solid rgba(255,255,255,0.4); position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;
        }
        #progress-bar { position: absolute; top: 0; left: 0; height: 6px; background: #fff; border-radius: 32px 32px 0 0; transition: 0.3s; width: 0%; }
        .page { display: none; flex-direction: column; animation: fadeIn 0.4s ease; }
        .page.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .inst-box { background: rgba(255,255,255,0.3); padding: 12px; border-radius: 12px; font-size: 0.85rem; margin-bottom: 15px; border-left: 4px solid var(--accent); color: #444; }
        h2 { font-size: 1.15rem; margin-bottom: 18px; text-align: center; color: #1e1b4b; line-height: 1.4; }
        .opt-btn { 
            background: rgba(255,255,255,0.5); border: 1px solid rgba(255,255,255,0.3); 
            padding: 14px; border-radius: 16px; color: #1e1b4b; margin-bottom: 10px; 
            cursor: pointer; text-align: center; font-weight: 500; transition: 0.2s; 
        }
        .opt-btn:active { background: #fff; transform: translateY(-2px); }
        .opt-btn.selected { background: var(--accent); color: white; border-color: var(--accent); }
        input { width: 100%; padding: 16px; border-radius: 15px; border: 1px solid rgba(0,0,0,0.1); font-size: 1.2rem; text-align: center; margin-bottom: 15px; box-sizing: border-box; font-weight: bold; background: rgba(255,255,255,0.8); }
        .active-btn { background: var(--accent); border: none; padding: 18px; border-radius: 18px; color: white; font-weight: bold; width: 100%; cursor: pointer; font-size: 1.1rem; box-shadow: 0 10px 20px rgba(255,36,66,0.3); }
        #result-page { display: none; position: fixed; inset: 0; background: #fdfdfd; z-index: 500; padding: 25px; overflow-y: auto; color: #333; }
        .loading-box { display: none; text-align: center; padding: 20px 0; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container" id="main-box">
    <div id="progress-bar"></div>

    <div id="quiz-page" class="page active">
        <div id="quiz-content"></div>
    </div>

    <div id="status-page" class="page">
        <h2>ğŸ¥ èº«ä½“çŠ¶æ€ä¸ä¼¤ç—…è¡¥å½•</h2>
        <div class="inst-box">è¯·å¦‚å®é€‰æ‹©ï¼ŒAI å°†ä¸ºæ‚¨è§„é¿å¯èƒ½åŠ é‡ç–¼ç—›çš„åŠ¨ä½œã€‚</div>
        <p style="font-size:0.85rem; margin-bottom:10px; font-weight:bold;">1. æ˜¯å¦æœ‰é™ˆæ—§æ€§ä¼¤ç—…æˆ–ç°é˜¶æ®µç–¼ç—›ï¼Ÿ</p>
        <div class="opt-btn" onclick="addStatus('injury','æ— ä¼¤ç—…')">æ— ä¼¤ç—…ï¼Œèº«ä½“å¥åº·</div>
        <div class="opt-btn" onclick="addStatus('injury','è…°æ¤é—´ç›˜çªå‡º/è…°ç—›')">è…°æ¤ä¸é€‚ (å¦‚è…°çª/é…¸ç—›)</div>
        <div class="opt-btn" onclick="addStatus('injury','è†ç›–åŠæœˆæ¿/å…³èŠ‚ç—›')">è†å…³èŠ‚ä¸é€‚ (å¦‚å¼¹å“/å‹ç—›)</div>
        <div class="opt-btn" onclick="addStatus('injury','é¢ˆæ¤ç—…/åå¤´ç—›')">é¢ˆæ¤ä¸é€‚ (å¦‚æ‰‹éº»/å¤´æ™•)</div>
        
        <p style="font-size:0.85rem; margin:15px 0 10px; font-weight:bold;">2. æ‚¨æœ€è¿‘åŠå¹´çš„è¿åŠ¨é¢‘ç‡ï¼Ÿ</p>
        <div class="opt-btn" onclick="addStatus('freq','å‡ ä¹ä¸è¿åŠ¨')">å°ç™½ (å‡ ä¹ä¸è¿åŠ¨)</div>
        <div class="opt-btn" onclick="addStatus('freq','æ¯å‘¨1-2æ¬¡')">å¶å°” (æ¯å‘¨ 1-2 æ¬¡)</div>
        <div class="opt-btn" onclick="addStatus('freq','æ¯å‘¨3æ¬¡åŠä»¥ä¸Š')">å¸¸å®¢ (æ¯å‘¨ 3 æ¬¡ä»¥ä¸Š)</div>
    </div>

    <div id="cardio-page" class="page">
        <h2>ğŸ’“ å¿ƒè‚ºä¸ç¨³å®šæ€§æŒ‘æˆ˜</h2>
        <div class="inst-box">è¯·åŸåœ°èµ·ç«‹ï¼Œå°è¯•å¿«é€Ÿå®Œæˆ 20 æ¬¡æ·±è¹²ã€‚</div>
        <p style="font-size:0.9rem; text-align:center;">å®Œæˆåï¼Œè¯·æ„Ÿå—æ‚¨çš„å³æ—¶çŠ¶æ€ï¼š</p>
        <div class="opt-btn" onclick="setCardio('è½»æ¾ï¼Œå‘¼å¸å¹³ç¨³')">è½»æ¾ï¼Œå‘¼å¸åŸºæœ¬å¹³ç¨³</div>
        <div class="opt-btn" onclick="setCardio('æ°”å–˜ï¼Œä½†èƒ½è¯´è¯')">ç•¥å¾®æ°”å–˜ï¼Œä½†èƒ½è¿ç»­è¯´è¯</div>
        <div class="opt-btn" onclick="setCardio('å‰§çƒˆå–˜æ°”ï¼Œå¿ƒè·³æå¿«')">å‰§çƒˆå–˜æ°”ï¼Œæ„Ÿåˆ°ä½“åŠ›é€æ”¯</div>
        <div class="opt-btn" onclick="setCardio('è…¿éƒ¨å‘æŠ–ï¼Œå¹³è¡¡ä¸ç¨³')">è…¿éƒ¨å‘æŠ–ï¼Œéš¾ä»¥ç»´æŒå¹³è¡¡</div>
    </div>

    <div id="env-page" class="page">
        <h2>ğŸ“ é€‰æ‹©ç»ƒä¹ åœºæ™¯</h2>
        <div class="opt-btn" onclick="setEnv('åœ¨å®¶(æ— å™¨æ¢°)')">ğŸ  åœ¨å®¶ (å¾’æ‰‹/ç®€å•è¾…åŠ©)</div>
        <div class="opt-btn" onclick="setEnv('å¥èº«æˆ¿(å…¨å™¨æ¢°)')">ğŸ’ª å¥èº«æˆ¿ (ä¸“ä¸šå™¨æ¢°)</div>
        <div class="opt-btn" onclick="setEnv('åŠå…¬å®¤/ç‘œä¼½é¦†')">ğŸ§˜ ç‘œä¼½é¦†/åŠå…¬å®¤ (ç¢ç‰‡åŒ–)</div>
    </div>

    <div id="auth-page" class="page">
        <h2>ğŸ”“ éªŒè¯è®¢å• å¼€å¯è®¡åˆ’</h2>
        <div class="inst-box">å…¨ç»´åº¦è¯„ä¼°å·²å®Œæˆï¼è¯·è¾“å…¥è®¢å•å·å 6 ä½ï¼Œè·å–é’ˆå¯¹æ‚¨èº«ä½“ç°çŠ¶å®šåˆ¶çš„ 30 å¤©æ–¹æ¡ˆã€‚</div>
        <input type="text" id="orderInput" placeholder="è¾“å…¥è®¢å•å·æœ« 6 ä½" maxlength="6">
        <button class="active-btn" onclick="verifyAndGo()">è·å– AI ä¸“å±è®¡åˆ’</button>
        <div class="loading-box" id="loader">
            <div class="spinner"></div>
            <p id="loader-text" style="font-size:0.8rem; color:white;">æ­£åœ¨åŒæ­¥ Supabase æ•°æ®åº“...</p>
        </div>
    </div>
</div>

<div id="result-page">
    <div id="md-body"></div>
    <button onclick="location.reload()" style="width:100%; padding:15px; background:#f4f4f5; border:none; border-radius:12px; margin-top:20px; font-weight:bold;">è¿”å›</button>
</div>

<script>
    const supabase = window.supabase.createClient(
        'https://xmikxquuskfbiyqavqru.supabase.co', 
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhtaWt4cXV1c2tmYml5cWF2cXJ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg4Mjc4NTksImV4cCI6MjA4NDQwMzg1OX0.WPWGtYctdyLjlTAuzV4iW_AmHZA4bSDUgOWGdzv6xOc'
    );

    const questions = [
        { inst: "è‡ªæ£€ 1: ä¾§èº«è§‚å¯Ÿ", q: "è€³å‚æ˜¯å¦æ˜æ˜¾åœ¨è‚©è†€å‰æ–¹ï¼Ÿ", opts: ["æ˜¯(å¤´å‰ä¼¸)", "åŸºæœ¬å‚ç›´", "ä¸ç¡®å®š"] },
        { inst: "è‡ªæ£€ 2: è‡ªç„¶ç«™ç«‹", q: "æ‰‹æŒå¿ƒæœå‘ï¼Ÿ", opts: ["å‘å(åœ†è‚©)", "å‘å¤§è…¿", "ç•¥å¾®åå"] },
        { inst: "è‡ªæ£€ 3: é å¢™ç«™ç«‹", q: "åè„‘å‹ºèƒ½å¦è´´åˆ°å¢™ï¼Ÿ", opts: ["è´´ä¸åˆ°", "è½»æ¾è´´åˆ°", "è´´åˆ°ä½†åƒåŠ›"] },
        { inst: "è‡ªæ£€ 4: è‚©è†€é«˜ä½", q: "åŒè‚©æ˜¯å¦æœ‰æ˜æ˜¾ä¸é½ï¼Ÿ", opts: ["å·¦é«˜", "å³é«˜", "åŸºæœ¬é½å¹³"] },
        { inst: "è‡ªæ£€ 5: é”éª¨å½¢æ€", q: "é”éª¨æ˜¯Vå‹è¿˜æ˜¯ä¸€å‹ï¼Ÿ", opts: ["æ˜æ˜¾çš„Vå‹", "å¹³ç›´ä¸€å­—å‹", "çœ‹ä¸æ¸…"] },
        { inst: "è‡ªæ£€ 6: è…°åç©ºéš™", q: "è…°ä¸å¢™ä¹‹é—´ç©ºéš™ï¼Ÿ", opts: ["å¡æ‹³å¤´(å‰å€¾)", "å¡ä¸€æŒ", "æ²¡ç¼(åå€¾)"] },
        { inst: "è‡ªæ£€ 7: è…¹éƒ¨çŠ¶æ€", q: "å››è‚¢ä¸èƒ–ä½†å°è…¹å‡¸ï¼Ÿ", opts: ["å¾ˆæ˜æ˜¾", "å¶å°”", "æ²¡æœ‰"] },
        { inst: "è‡ªæ£€ 8: ä»°å§å¹³èºº", q: "è„šå°–è‡ªç„¶å€’å‘è§’åº¦ï¼Ÿ", opts: ["æ˜æ˜¾ä¸å¯¹ç§°", "åŸºæœ¬å¯¹ç§°", "ä¸ç¡®å®š"] },
        { inst: "è‡ªæ£€ 9: é‹åº•ç£¨æŸ", q: "å¤–ä¾§ç£¨æŸå¤šè¿˜æ˜¯å†…ä¾§ï¼Ÿ", opts: ["å¤–ä¾§(Oå‹)", "å†…ä¾§(Xå‹)", "è¾ƒå‡åŒ€"] },
        { inst: "è‡ªæ£€ 10: è†ç›–ä½ç½®", q: "å¹¶è„šç«™ç«‹è†ç›–èƒ½ç¢°åˆ°å—ï¼Ÿ", opts: ["ç¢°ä¸åˆ°", "ç¢°å¾—åˆ°", "è†ç›–å†…æ‰£"] },
        { inst: "è‡ªæ£€ 11: è‚©èƒ›éª¨", q: "è‚©èƒ›éª¨æ˜¯å¦æ˜æ˜¾å‡¸èµ·ï¼Ÿ", opts: ["æ˜æ˜¾å‡¸èµ·", "å¹³æ•´è´´åˆ", "ç•¥å¾®å‡¸èµ·"] },
        { inst: "ç—‡çŠ¶ 12: ä¹…åæ„Ÿ", q: "è¿ç»­å1å°æ—¶å“ªé‡Œæœ€é…¸ï¼Ÿ", opts: ["é¢ˆå", "è…°éª¶", "è‡€éƒ¨"] },
        { inst: "ç—‡çŠ¶ 13: ç¡çœ å§¿åŠ¿", q: "ä¹ æƒ¯å¹³èººè¿˜æ˜¯ä¾§å§ï¼Ÿ", opts: ["å¿…é¡»ä¾§å§", "å¹³èººèˆ’æœ", "èœ·ç¼©"] },
        { inst: "ç—‡çŠ¶ 14: å‘¼å¸èµ·ä¼", q: "æ·±å‘¼å¸å“ªé‡Œèµ·ä¼å¤§ï¼Ÿ", opts: ["èƒ¸å£", "è‚šå­", "éƒ½æœ‰"] },
        { inst: "è¿åŠ¨ 15: åŒæ‰‹åå‹¾", q: "åŒæ‰‹èƒ½åœ¨èƒŒåæ‘¸åˆ°å—ï¼Ÿ", opts: ["æ‘¸ä¸åˆ°", "å‹‰å¼ºç¢°åˆ°", "è½»æ¾å‹¾ä½"] },
        { inst: "è¿åŠ¨ 16: äºšæ´²è¹²", q: "è„šè·Ÿä¸ç¦»åœ°ä¼šåå€’å—ï¼Ÿ", opts: ["ä¼šå€’", "è½»æ¾", "å¼ è…¿è¹²"] },
        { inst: "ç—‡çŠ¶ 17: è½¬é¢ˆå“å£°", q: "è„–å­å“æˆ–æ™•å—ï¼Ÿ", opts: ["å“ä¸”æ™•", "å¶å°”å“", "ä»ä¸å“"] },
        { inst: "ç”Ÿæ´» 18: æ‰‹æœºæ—¶é•¿", q: "æ¯å¤©ä½å¤´ç©æ‰‹æœºå¤šä¹…ï¼Ÿ", opts: ["5h+", "2-5h", "2hå†…"] },
        { inst: "ç”Ÿæ´» 19: ä¹ æƒ¯å§¿åŠ¿", q: "ä¹ æƒ¯ç¿˜äºŒéƒè…¿å—ï¼Ÿ", opts: ["ç»å¸¸ç¿˜", "å¶å°”", "ä»ä¸"] },
        { inst: "ç»ˆæ 20: èº«ä½“æ„Ÿ", q: "å¹³æ—¶æ„Ÿè§‰èº«ä½“æ²‰é‡å—ï¼Ÿ", opts: ["ç»å¸¸ä¹åŠ›", "è¿˜å¥½", "ç²¾åŠ›å……æ²›"] }
    ];

    let currentIdx = 0;
    let userData = { quiz: [], injury: "", freq: "", cardio: "", env: "" };

    function renderQuiz() {
        const q = questions[currentIdx];
        const box = document.getElementById('quiz-content');
        box.innerHTML = `<div class="inst-box">${q.inst}</div><h2>${q.q}</h2>`;
        q.opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'opt-btn';
            btn.innerText = o;
            btn.onclick = () => {
                userData.quiz.push(o);
                if(currentIdx < questions.length - 1) {
                    currentIdx++;
                    renderQuiz();
                } else {
                    switchPage('quiz-page', 'status-page');
                }
                document.getElementById('progress-bar').style.width = ((currentIdx+1)/(questions.length+3))*100 + '%';
            };
            box.appendChild(btn);
        });
    }

    function addStatus(type, val) {
        userData[type] = val;
        // å¦‚æœä¸¤é¡¹éƒ½é€‰äº†ï¼Œè·³ä¸‹ä¸€é¡µ
        if(userData.injury && userData.freq) switchPage('status-page', 'cardio-page');
    }

    function setCardio(val) {
        userData.cardio = val;
        switchPage('cardio-page', 'env-page');
    }

    function setEnv(val) {
        userData.env = val;
        switchPage('env-page', 'auth-page');
    }

    function switchPage(oldId, newId) {
        document.getElementById(oldId).classList.remove('active');
        document.getElementById(newId).classList.add('active');
    }

    async function verifyAndGo() {
        const orderId = document.getElementById('orderInput').value.trim();
        if(!/^\d{6}$/.test(orderId)) { alert("è¯·è¾“å…¥å•å·å6ä½"); return; }
        document.getElementById('loader').style.display = 'block';
        try {
            const { data } = await supabase.from('orders').select('*').eq('order_id', orderId).single();
            if(data && data.is_used) { alert("å•å·å·²æ¿€æ´»"); location.reload(); return; }
            await supabase.from('orders').upsert({ order_id: orderId, is_used: true });
            await runAI();
        } catch(e) { 
            await supabase.from('orders').upsert({ order_id: orderId, is_used: true });
            await runAI(); 
        }
    }

    async function runAI() {
        const KEY = "sk-d37975a862d84a7580adf1759cee3a1a"; 
        try {
            const res = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${KEY}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [
                        {role: "system", content: "ä½ æ˜¯ä¸€ä½ç²¾é€šåº·å¤åŒ»å­¦å’Œç”Ÿç‰©åŠ›å­¦çš„é¡¶çº§æ•™ç»ƒã€‚"},
                        {role: "user", content: `ç”¨æˆ·ä½“æ€æ•°æ®ï¼š${userData.quiz.join('/')}ã€‚ä¼¤ç—…ï¼š${userData.injury}ã€‚è¿åŠ¨é¢‘ç‡ï¼š${userData.freq}ã€‚å¿ƒè‚ºå‹åŠ›è‡ªæµ‹ï¼š${userData.cardio}ã€‚ç¯å¢ƒï¼š${userData.env}ã€‚
                        è¯·ï¼š1. è¯Šæ–­ä½“æ€é—®é¢˜åŠæ½œåœ¨æŸä¼¤é£é™©ã€‚2. ç»™å‡º30å¤©å®šåˆ¶åŒ–çº æ­£è®¡åˆ’ã€‚3. å¿…é¡»ä¸¥æ ¼é¿å¼€ä¼¤ç—…éƒ¨ä½ï¼Œæ ¹æ®ä½“èƒ½è°ƒæ•´å¼ºåº¦ã€‚Markdownæ ¼å¼è¾“å‡ºã€‚`}
                    ]
                })
            });
            const data = await res.json();
            document.getElementById('main-box').style.display = 'none';
            document.getElementById('result-page').style.display = 'block';
            document.getElementById('md-body').innerHTML = marked.parse(data.choices[0].message.content);
        } catch(e) { alert("AI æ­£åœ¨å¿™ç¢Œï¼Œè¯·ç¨åå†è¯•"); }
    }
    renderQuiz();
</script>
</body>
</html>
